# InnoDB å­˜å‚¨å¼•æ“æ¶æ„èŒè´£åˆ†ç¦»æ–‡æ¡£ (ç®€åŒ–ç‰ˆ)

## æ¦‚è¿°

ç»è¿‡æ¶æ„ç®€åŒ–ï¼Œæˆ‘ä»¬å°†å­˜å‚¨ç®¡ç†åˆ†ä¸ºä¸¤ä¸ªä¸»è¦å±‚æ¬¡çš„ç®¡ç†å™¨ï¼Œæ¯ä¸ªç®¡ç†å™¨æœ‰å…¶ä¸“é—¨çš„èŒè´£èŒƒå›´ã€‚ç®€åŒ–åçš„æ¶æ„æ›´åŠ æ¸…æ™°ï¼Œé¿å…äº†å¤æ‚çš„å±‚æ¬¡åˆ’åˆ†ã€‚

##  æ¶æ„å±‚æ¬¡å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    StorageManager                          â”‚
â”‚                   (é¡¶å±‚ç»Ÿä¸€åè°ƒå™¨)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  èŒè´£: ç»Ÿä¸€åè°ƒã€ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€äº‹åŠ¡ç®¡ç†ã€æ¥å£æš´éœ²              â”‚
â”‚  - ç®¡ç†æ‰€æœ‰å­ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸ                                   â”‚
â”‚  - åè°ƒå„ç»„ä»¶é—´çš„äº¤äº’                                        â”‚
â”‚  - å¯¹å¤–æä¾›ç»Ÿä¸€çš„å­˜å‚¨æ¥å£                                     â”‚
â”‚  - ç®¡ç†äº‹åŠ¡å’Œä¼šè¯                                           â”‚
â”‚  - æ™ºèƒ½æ£€æµ‹å¹¶é¿å…é‡å¤åˆå§‹åŒ–IBDæ–‡ä»¶                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                 â”‚                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚   SpaceManager   â”‚ â”‚  SegmentManager â”‚ â”‚å…¶ä»–ç®¡ç†å™¨    â”‚
â”‚  (ç»Ÿä¸€IBDç®¡ç†)   â”‚ â”‚  (æ®µç®¡ç†å™¨)     â”‚ â”‚BufferPool  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚PageMgr     â”‚
â”‚ èŒè´£: æ‰€æœ‰IBDç®¡ç† â”‚ â”‚èŒè´£: æ®µç®¡ç†      â”‚ â”‚            â”‚
â”‚ - ç³»ç»Ÿè¡¨ç©ºé—´     â”‚ â”‚ - æ•°æ®æ®µç®¡ç†    â”‚ â”‚            â”‚
â”‚ - ç”¨æˆ·è¡¨ç©ºé—´     â”‚ â”‚ - ç´¢å¼•æ®µç®¡ç†    â”‚ â”‚            â”‚
â”‚ - è¡¨ç©ºé—´CRUD     â”‚ â”‚ - æ®µåˆ†é…å›æ”¶    â”‚ â”‚            â”‚
â”‚ - åŒºæ®µåˆ†é…å›æ”¶    â”‚ â”‚ - æ®µç”Ÿå‘½å‘¨æœŸ    â”‚ â”‚            â”‚
â”‚ - æ–‡ä»¶I/Oæ“ä½œ    â”‚ â”‚                â”‚ â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

##  è¯¦ç»†èŒè´£åˆ†ç¦»

### 1. StorageManager (å­˜å‚¨ç»Ÿä¸€åè°ƒå™¨)

**å®šä½**: æœ€é¡¶å±‚çš„ç®¡ç†å™¨ï¼Œè´Ÿè´£ç»Ÿä¸€åè°ƒå’Œå¯¹å¤–æ¥å£

**æ ¸å¿ƒèŒè´£**:
```go
type StorageManager struct {
    spaceMgr             basic.SpaceManager          // å§”æ‰˜ç»™SpaceManager
    segmentMgr           *SegmentManager             // æ®µç®¡ç†
    bufferPool           *buffer_pool.BufferPool     // ç¼“å†²æ± ç®¡ç†
    pageMgr              *DefaultPageManager         // é¡µé¢ç®¡ç†
    tablespaces          map[string]*TablespaceHandle // è¡¨ç©ºé—´ç¼“å­˜
    nextTxID             uint64                      // äº‹åŠ¡IDç”Ÿæˆ
    mu                   sync.RWMutex               // å¹¶å‘æ§åˆ¶
}
```

**å…·ä½“èŒè´£**:
1. **ç³»ç»Ÿåˆå§‹åŒ–åè°ƒ**: 
   - æ£€æŸ¥IBDæ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œé¿å…é‡å¤åˆ›å»º
   - åè°ƒç³»ç»Ÿè¡¨ç©ºé—´å’Œç”¨æˆ·è¡¨ç©ºé—´çš„åˆå§‹åŒ–é¡ºåº
   - å¤„ç†å¹¶å‘åˆ›å»ºæ—¶çš„å†²çªæ£€æµ‹

2. **æ™ºèƒ½åˆå§‹åŒ–é€»è¾‘**:
   ```go
   // æ™ºèƒ½æ£€æµ‹ç°æœ‰IBDæ–‡ä»¶
   func (sm *StorageManager) createSystemTablespace(conf *conf.Cfg) error {
       // 1. å…ˆæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
       if existingSpace, err := sm.spaceMgr.GetSpace(0); err == nil {
           // å·²å­˜åœ¨ -> ç›´æ¥åˆ›å»ºhandleï¼Œä¸é‡å¤åˆå§‹åŒ–
           sm.createHandle(existingSpace)
           return nil
       }
       
       // 2. ä¸å­˜åœ¨ -> åˆ›å»ºæ–°çš„ç³»ç»Ÿè¡¨ç©ºé—´
       systemSpace, err := sm.spaceMgr.CreateSpace(0, fileName, true)
       return err
   }
   ```

3. **èŒè´£å§”æ‰˜**: å°†æ‰€æœ‰å…·ä½“æ“ä½œå§”æ‰˜ç»™ä¸“é—¨çš„ç®¡ç†å™¨
4. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**: ç®¡ç†æ‰€æœ‰å­ç»„ä»¶çš„åˆ›å»ºã€åˆå§‹åŒ–ã€å…³é—­
5. **äº‹åŠ¡åè°ƒ**: åè°ƒå„ç»„ä»¶å‚ä¸äº‹åŠ¡å¤„ç†
6. **æ¥å£æš´éœ²**: ä¸ºä¸Šå±‚æä¾›ç»Ÿä¸€çš„å­˜å‚¨æ“ä½œæ¥å£

---

### 2. SpaceManager (ç»Ÿä¸€IBDæ–‡ä»¶ç®¡ç†å™¨) 

**å®šä½**: åŸºç¡€è®¾æ–½å±‚ï¼Œè´Ÿè´£æ‰€æœ‰IBDæ–‡ä»¶çš„ç»Ÿä¸€ç®¡ç†

**æ ¸å¿ƒèŒè´£**:
```go
type SpaceManager interface {
    // è¡¨ç©ºé—´ç”Ÿå‘½å‘¨æœŸç®¡ç†
    CreateSpace(spaceID uint32, name string, isSystem bool) error
    GetSpace(spaceID uint32) (basic.IBDSpace, error)
    DropSpace(spaceID uint32) error
    
    // åŒºæ®µåˆ†é…ç®¡ç†
    AllocateExtent(spaceID uint32, purpose basic.ExtentPurpose) error
    FreeExtent(spaceID, extentID uint32) error
    
    // æ–‡ä»¶I/Oæ“ä½œ
    ReadPage(spaceID, pageNo uint32) ([]byte, error)
    WritePage(spaceID, pageNo uint32, data []byte) error
}
```

**ç®¡ç†èŒƒå›´**:
1. **æ‰€æœ‰IBDæ–‡ä»¶**: 
   - ç³»ç»Ÿè¡¨ç©ºé—´(space_id=0, ibdata1)
   - MySQLç³»ç»Ÿæ•°æ®åº“è¡¨ç©ºé—´(space_id=1-26, mysql/*)
   - information_schemaè¡¨ç©ºé—´(space_id=100+)
   - performance_schemaè¡¨ç©ºé—´(space_id=200+)
   - ç”¨æˆ·è¡¨ç©ºé—´(space_idè‡ªå®šä¹‰)

2. **ç»Ÿä¸€æ–‡ä»¶ç®¡ç†**: 
   - åˆ›å»ºã€æ‰“å¼€ã€å…³é—­ã€åˆ é™¤ `.ibd` æ–‡ä»¶
   - ä¸åŒºåˆ†ç³»ç»Ÿè¡¨ç©ºé—´å’Œç”¨æˆ·è¡¨ç©ºé—´ï¼Œç»Ÿä¸€å¤„ç†

3. **ç©ºé—´åˆ†é…**: 
   - ç®¡ç†åŒº(Extent)å’Œé¡µé¢çš„åˆ†é…ä¸å›æ”¶
   - å¤„ç†åº•å±‚çš„æ–‡ä»¶è¯»å†™æ“ä½œ

**ç®€åŒ–ä¼˜åŠ¿**: SpaceManagerä¸éœ€è¦å…³å¿ƒè¡¨ç©ºé—´å†…å®¹çš„è¯­ä¹‰å·®å¼‚ï¼Œä¸“æ³¨äºç‰©ç†æ–‡ä»¶ç®¡ç†

---

### 3. SegmentManager (æ®µç®¡ç†å™¨)

**å®šä½**: æ®µçº§åˆ«çš„ç®¡ç†å™¨ï¼Œè´Ÿè´£æ•°æ®æ®µå’Œç´¢å¼•æ®µçš„ç®¡ç†

**æ ¸å¿ƒèŒè´£**:
```go
type SegmentManager struct {
    bufferPool     *buffer_pool.BufferPool
    segments       map[uint32]*SegmentImpl  // æ®µç¼“å­˜
    mu             sync.RWMutex
}
```

**ä¸“ä¸šèŒè´£**:
1. **æ®µç±»å‹ç®¡ç†**:
   - æ•°æ®æ®µ(SEGMENT_TYPE_DATA): å­˜å‚¨è¡¨æ•°æ®
   - ç´¢å¼•æ®µ(SEGMENT_TYPE_INDEX): å­˜å‚¨ç´¢å¼•æ•°æ®

2. **æ®µç”Ÿå‘½å‘¨æœŸ**:
   - åˆ›å»ºæ®µ(CreateSegment)
   - è·å–æ®µ(GetSegment) 
   - åˆ é™¤æ®µ(DropSegment)

3. **é¡µé¢åˆ†é…**:
   - ä¸ºæ®µåˆ†é…é¡µé¢(AllocatePage)
   - ç®¡ç†æ®µå†…çš„é¡µé¢ä½¿ç”¨

---

## ğŸ”„ ç®€åŒ–åçš„åˆå§‹åŒ–æµç¨‹

### ç³»ç»Ÿå¯åŠ¨æ—¶çš„èŒè´£åˆ†å·¥:

```mermaid
sequenceDiagram
    participant SM as StorageManager
    participant SpM as SpaceManager  
    participant SegM as SegmentManager
    
    SM->>SM: initializeSystemTablespaces()
    
    SM->>SM: 1. createSystemTablespace()
    SM->>SpM: æ£€æŸ¥space_id=0æ˜¯å¦å­˜åœ¨
    alt IBDæ–‡ä»¶å·²å­˜åœ¨
        SpM-->>SM: è¿”å›ç°æœ‰Space
        SM->>SM: åˆ›å»ºHandleï¼Œè·³è¿‡åˆå§‹åŒ–
    else IBDæ–‡ä»¶ä¸å­˜åœ¨  
        SM->>SpM: CreateSpace(0, "ibdata1", true)
        SpM-->>SM: è¿”å›æ–°åˆ›å»ºçš„Space
        SM->>SM: åˆ›å»ºHandle
    end
    
    SM->>SM: 2. createMySQLSystemTablespaces()
    loop å¯¹æ¯ä¸ªmysql/*è¡¨(space_id=1-26)
        SM->>SpM: æ£€æŸ¥space_idæ˜¯å¦å­˜åœ¨
        alt ä¸å­˜åœ¨
            SM->>SpM: CreateSpace(space_id, name, true)
        end
        SM->>SM: åˆ›å»ºHandle
    end
    
    SM->>SM: 3. createInformationSchema(space_id=100+)
    SM->>SM: 4. createPerformanceSchema(space_id=200+)
    Note over SM,SpM: æ‰€æœ‰è¡¨ç©ºé—´éƒ½ç”±SpaceManagerç»Ÿä¸€ç®¡ç†
    
    SM->>SM: 5. InitializeMySQLUserData()
    SM->>SegM: åˆ›å»ºå¿…è¦çš„æ•°æ®æ®µ
```

##  å…³é”®è®¾è®¡åŸåˆ™

### 1. **èŒè´£å•ä¸€æ€§**
- **SpaceManager**: ä¸“æ³¨æ‰€æœ‰IBDæ–‡ä»¶ç®¡ç†ï¼Œä¸åŒºåˆ†ç³»ç»Ÿ/ç”¨æˆ·è¡¨ç©ºé—´
- **SegmentManager**: ä¸“æ³¨æ®µçº§åˆ«çš„ç®¡ç†
- **StorageManager**: ä¸“æ³¨åè°ƒï¼Œä¸ç›´æ¥æ“ä½œæ–‡ä»¶

### 2. **æ™ºèƒ½é¿é‡å¤**
```go
// StorageManagerçš„æ™ºèƒ½æ£€æŸ¥é€»è¾‘
func (sm *StorageManager) createMySQLSystemTablespaces() error {
    for i, tableName := range systemTables {
        spaceID := uint32(i + 1)
        
        // 1. æ£€æŸ¥æˆ‘ä»¬çš„tablespacesç¼“å­˜
        if _, exists := sm.tablespaces[tableName]; exists {
            continue // å·²åœ¨ç¼“å­˜ä¸­
        }
        
        // 2. æ£€æŸ¥SpaceManagerä¸­æ˜¯å¦å·²å­˜åœ¨
        if existingSpace, err := sm.spaceMgr.GetSpace(spaceID); err == nil {
            // å·²å­˜åœ¨ï¼Œåªåˆ›å»ºhandle
            sm.createHandle(existingSpace)
            continue
        }
        
        // 3. ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°çš„
        sm.spaceMgr.CreateSpace(spaceID, tableName, true)
        sm.createHandle(...)
    }
}
```

### 3. **é”™è¯¯æ¢å¤èƒ½åŠ›**
- æ£€æµ‹å¹¶å‘åˆ›å»ºçš„é‡å¤IBDæ–‡ä»¶
- å¤„ç†éƒ¨åˆ†åˆå§‹åŒ–å¤±è´¥çš„æ¢å¤
- éªŒè¯ç°æœ‰IBDæ–‡ä»¶çš„å®Œæ•´æ€§

### 4. **ç»Ÿä¸€ç®¡ç†ä¼˜åŠ¿**
- æ‰€æœ‰IBDæ–‡ä»¶ç”±SpaceManagerç»Ÿä¸€ç®¡ç†ï¼Œç®€åŒ–äº†æ¥å£
- é¿å…äº†ç³»ç»Ÿè¡¨ç©ºé—´å’Œç”¨æˆ·è¡¨ç©ºé—´çš„å¤æ‚åŒºåˆ†
- æ›´æ˜“äºç»´æŠ¤å’Œæ‰©å±•

##  IBDæ–‡ä»¶åˆ†å¸ƒ

ç»è¿‡ç®€åŒ–çš„æ¶æ„ä¸­ï¼Œæ‰€æœ‰IBDæ–‡ä»¶éƒ½ç”±SpaceManagerç»Ÿä¸€ç®¡ç†ï¼š

```
data/
â”œâ”€â”€ ibdata1                    # ç³»ç»Ÿè¡¨ç©ºé—´ (Space ID: 0)
â”œâ”€â”€ mysql_user.ibd            # MySQLç”¨æˆ·è¡¨ (Space ID: 1)
â”œâ”€â”€ mysql_db.ibd              # MySQLæ•°æ®åº“è¡¨ (Space ID: 2)
â”œâ”€â”€ ...                       # å…¶ä»–MySQLç³»ç»Ÿè¡¨ (Space ID: 3-26)
â”œâ”€â”€ information_schema_schemata.ibd  # info schema (Space ID: 100+)
â”œâ”€â”€ performance_schema_accounts.ibd  # perf schema (Space ID: 200+)
â””â”€â”€ user_table.ibd            # ç”¨æˆ·è¡¨ (Space ID: è‡ªå®šä¹‰)
```

## âœ¨ ç®€åŒ–æ¶æ„çš„ä¼˜åŠ¿

1. **æ›´æ¸…æ™°çš„èŒè´£**: å»é™¤äº†SystemSpaceManagerçš„å¤æ‚å±‚æ¬¡
2. **ç»Ÿä¸€çš„ç®¡ç†**: SpaceManagerç»Ÿä¸€ç®¡ç†æ‰€æœ‰IBDæ–‡ä»¶
3. **ç®€åŒ–çš„æ¥å£**: å‡å°‘äº†ç»„ä»¶é—´çš„å¤æ‚äº¤äº’
4. **æ›´å¥½çš„ç»´æŠ¤æ€§**: ä»£ç ç»“æ„æ›´ç®€å•ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤
5. **æ™ºèƒ½åˆå§‹åŒ–**: è‡ªåŠ¨æ£€æµ‹ç°æœ‰æ–‡ä»¶ï¼Œé¿å…é‡å¤åˆ›å»º

è¿™æ ·çš„ç®€åŒ–è®¾è®¡ç¡®ä¿äº†ï¼š
- **SpaceManager**ä¸“æ³¨äºæ‰€æœ‰IBDæ–‡ä»¶çš„ç‰©ç†ç®¡ç†
- **SegmentManager**ä¸“æ³¨äºæ®µçº§åˆ«çš„é€»è¾‘ç®¡ç†  
- **StorageManager**ä¸“æ³¨äºæ•´ä½“åè°ƒå’Œç”Ÿå‘½å‘¨æœŸç®¡ç†
- é¿å…äº†é‡å¤åˆå§‹åŒ–å’Œè¦†ç›–ç°æœ‰æ•°æ®çš„é—®é¢˜ 